# **Beowulf AI System Architecture**
### _Intelligent Discord Assistant with Memory, Tools, and External Data Integration_

---

## **Overview**

This document describes the full architecture for the **Beowulf AI System**—an intelligent, personality-driven Discord assistant capable of:

- Deep short-term & long-term memory  
- Tool calling for accurate, real-time external data  
- Context-aware banter using historical chat context  
- GPT-powered reasoning and persona-driven dialogue  
- Clean modular orchestration in Node.js + TypeScript  
- PGVector-backed semantic retrieval for high-quality memory recall  

This architecture is structured for incremental development and GPT-powered code generation.

---

# **System Summary**

The Beowulf assistant consists of **six core subsystems**:

1. **Orchestrator** – central AI interaction router  
2. **Intent Classifier** – identifies user intent  
3. **Context Builder** – assembles all data needed for GPT  
4. **Tools System** – external data functions (market, stats, org info)  
5. **Persona Responder** – GPT response generator with tool-calling  
6. **Memory Writer** – stores new long-term memories with embeddings  

These subsystems work together to create a smart, personality-rich assistant.

---

# **1. File & Folder Structure**

```
/src
  /commands
  /config
  /context
    builder.ts
    index.ts
  /events
    messageCreate.ts
    interactionCreate.ts
  /intent
    classifier.ts
  /memory
    writer.ts
    models.ts
  /orchestrator
    index.ts
  /persona
    responder.ts
  /tools
    index.ts
    /functions
      market.ts
      stats.ts
      org.ts
  /data
    cache.ts
    /refreshers
  /db
    /migrations
    client.ts
  app.ts
```

### **Folder Purpose Summary**

| Folder | Purpose |
|--------|---------|
| `/orchestrator` | Core AI routing pipeline |
| `/intent` | Intent detection using GPT |
| `/context` | Builds short-term + long-term memory + data context |
| `/persona` | GPT persona logic + final response generation |
| `/tools` | Tool-calling functions for external data |
| `/memory` | Long-term memory writer & models |
| `/events` | Discord.js event listeners |
| `/commands` | Slash command definitions |
| `/data` | Cached game data & refreshers |
| `/db` | Postgres client + migrations |
| `app.ts` | Project entrypoint |

### **Beowulf Runtime Mapping**

The live Node.js implementation in this repository mirrors the architecture by exposing the following directories under `chatgpt/`:

- `chatgpt/orchestrator` – wires message events from `index.js` into the pipeline.
- `chatgpt/intent` – lightweight classifier that tags banter, price queries, stats lookups, etc.
- `chatgpt/context` – hydrates context exclusively from the global caches outlined in `GLOBAL-CACHES.md`.
- `chatgpt/tools` – helper accessors that read `globalThis.userListCache`, `chatMessagesCache`, `uexCache`, `playerStatsCache`, `leaderboardCache`, and `hitCache`.
- `chatgpt/persona` – persona prompt + OpenAI response handler (currently targeting GPT-5.1 compatible models).
- `chatgpt/memory` – optional writer that reuses the vector-ingest utilities when `KNOWLEDGE_INGEST_ENABLE=true`.

The Discord entrypoint (`index.js`) now routes any mention or reply to Beowulf through `handleChatGptInteraction`, ensuring every subsystem is engaged in-order.

### **Implementation Notes**

- The intent classifier first runs fast keyword heuristics, then confirms the result with a lightweight GPT model (`CHATGPT_INTENT_MODEL`, default `gpt-4o-mini`) that returns a JSON intent payload.
- Orchestrator stage timing logs (`[ChatGPT][Perf] ...`) surface how long intent, context, persona, and memory stages take, helping debug any >5s latency.
- Cache readiness helpers automatically hydrate leaderboard, market (UEX), player stats, and hit caches on-demand so context building rarely blocks on cold data.

---

# **2. Database Schema (Postgres + pgvector)**

The database uses **pgvector** for embeddings.  
Below are the required tables.

---

## **2.1 `memories`**

Stores long-term memory entries: events, jokes, preferences, lore, etc.

| Field | Type |
|-------|------|
| id | UUID PK |
| user_id | TEXT (nullable) |
| guild_id | TEXT |
| channel_id | TEXT (nullable) |
| type | TEXT (`episodic`, `inside_joke`, `profile`, `lore`) |
| content | TEXT |
| tags | TEXT[] |
| importance | INT |
| vector | vector(1536) |
| created_at | TIMESTAMPTZ |
| updated_at | TIMESTAMPTZ |
| last_used_at | TIMESTAMPTZ |

---

## **2.2 `user_profiles`**

Stores persistent attributes about each player/user.

| Field | Type |
|-------|------|
| user_id | TEXT PK |
| nickname | TEXT |
| tease_level | INT |
| style_preferences | JSONB |
| stats_json | JSONB |
| created_at | TIMESTAMPTZ |
| updated_at | TIMESTAMPTZ |

`stats_json` now carries rich persona details generated by the memory curator. Expected keys:

- `persona_details.profession`: One-line descriptor (`"Pirate logistician"`).
- `persona_details.known_for`: Array of memorable traits/achievements.
- `persona_details.favorite_topics`: Array of conversation hooks.
- `persona_details.notable_quotes`: Short quotes we can reference in banter.
- `persona_details.achievements`, `persona_details.notable_traits`, `persona_details.catchphrase`, `persona_details.relationship_notes`, `persona_details.personality_summary`.
- `persona_details.traits`: Object with 0–10 sliders for `openness`, `conscientiousness`, `extraversion`, `agreeableness`, `neuroticism`, `confidence`, `courage`, `integrity`, `resilience`, `humor` (slowly refined from prior data).
- `last_persona_update`: ISO timestamp of the most recent GPT adjustment.

Feel free to add additional biography-style keys under `persona_details` so long as they serialize to JSON.

---

## **2.3 `chat_messages`**

Short-term memory representing recent conversation.

| Field | Type |
|-------|------|
| id | UUID PK |
| guild_id | TEXT |
| channel_id | TEXT |
| user_id | TEXT |
| content | TEXT |
| timestamp | TIMESTAMPTZ |

---

## **2.4 `knowledge_docs`**

Long-form documentation for RAG-style knowledge (guides, rules, trading hints).

| Field | Type |
|-------|------|
| id | UUID PK |
| title | TEXT |
| text | TEXT |
| tags | TEXT[] |
| vector | vector(1536) |
| version | TEXT |
| created_at | TIMESTAMPTZ |

---

# **3. Orchestration Pipeline**

```
Discord Message
      ↓
Intent Classifier
      ↓
Context Builder
      ↓
Persona Responder (GPT)
  ↳ (Optional Tool Calls)
      ↓
Final Response Sent to Discord
      ↓
Memory Writer
```

---

# **4. Intent Classifier**

Determines what category a message falls into.

### **Intent Categories**
- `banter`
- `price_query`
- `user_stats`
- `serious_info`
- `help`
- `admin`
- `other`

### **Output Contract**
```ts
{
  intent: string;
  needsTool: boolean;
  confidence: number;
}
```

---

# **5. Context Builder**

Assembles everything GPT needs to respond correctly.

### **Sources of Context**

1. **Short-term memory**  
2. **Long-term memory (vector search)**  
3. **Knowledge documents**  
4. **External data**

### **Output Interface:**
```ts
interface BuiltContext {
  recentChat: ChatMessage[];
  longTermMemories: Memory[];
  knowledgeSnippets: KnowledgeDoc[];
  externalData: any;
}
```

---

# **6. Tools System (Function Calling)**

GPT calls tools for any external data that must be accurate.

### **Tools Provided**
- `get_item_price(item, region?)`
- `get_user_stats(userId)`
- `get_market_trends(item)`
- `get_org_rank(userId)`

---

# **7. Persona Responder**

The GPT module responsible for final response generation.

---

# **8. Memory Writer**

Analyzes conversations and stores new memories with embeddings.

**Batch Worker:** `chatgpt/memory/batch-runner.js` watches cached chat logs per channel. It buffers live messages, flushing either when 10 new entries arrive or when a 3-minute interval elapses (whichever happens first). Batches are forwarded to `chatgpt/memory/batch-processor.js`, which now:
- Ignores any messages authored by Beowulf (so the bot never reinforces its own statements) before building the JSON transcript.
- Calls `CHATGPT_MEMORY_MODEL` (default `gpt-4o-mini`) with a strict JSON schema request that supports six memory types: `episodic`, `inside_joke`, `profile`, `lore`, plus the advice-specific `dogfighting_advice` (ship combat tactics) and `piracy_advice` (routes, snare setups, loot intel).
- Writes approved summaries into the dedicated `memories` table via `chatgpt/memory/memory-store.js`, embedding each entry for vector recall.
- Applies persona tweaks by upserting rows in `user_profiles` (nickname, tease level, style preferences, `persona_details` fields, numeric trait sliders) and updating the runtime cache so the persona responder immediately sees the new profile data.

**Persona Consumption:** `globalThis.userProfilesCache` hydrates from `/api/userprofiles` (`common/user-profiles-cache.js`). `chatgpt/context/builder.js` now prefers this cache when populating `context.userProfile`, ensuring the responder sees any adjustments emitted by the memory curator, including the extended `persona_details` (profession, known_for, favorite_topics, quotes, achievements, relationship notes, catchphrases, personality summary, trait sliders for Openness/Conscientiousness/Extraversion/Agreeableness/Neuroticism plus Confidence, Courage, Integrity, Resilience, Humor).

**Historical Seeding:** Run `npm run preload:memories` to replay the last 1,000 messages per configured channel (chunks of 10). The script (`scripts/preload-memories.js`) refreshes `user_profiles` and feeds each chunk through the same GPT-based memory + persona pipeline so new installations can bootstrap lore quickly.

---

# **9. Discord Integration**

Routes all Discord messages into the Orchestrator.

---

# **10. GPT-5.1 Build Prompts**

Use these prompts to generate each subsystem.

---

# **11. Data Refreshers**

Used for market sync, user stats, API scraping, and cached data.

---

# **12. System Diagram**

```
          ┌────────────────────┐
          │ Discord Message     │
          └───────┬────────────┘
                  │
          ┌───────▼────────────┐
          │ Intent Classifier   │
          └───────┬────────────┘
                  │
          ┌───────▼────────────┐
          │  Context Builder    │
          └───────┬────────────┘
                  │
      ┌───────────▼────────────────┐
      │      Persona Responder     │
      │        (GPT 5.1)           │
      └───────────┬────────────────┘
                  │ tool calls
          ┌───────▼────────────┐
          │   Tools Layer      │
          └───────┬────────────┘
                  │ data
          ┌───────▼────────────┐
          │   External Cache    │
          └───────┬────────────┘
                  │
          ┌───────▼────────────┐
          │  Final Response     │
          └───────┬────────────┘
                  │
          ┌───────▼────────────┐
          │  Memory Writer      │
          └─────────────────────┘
```










